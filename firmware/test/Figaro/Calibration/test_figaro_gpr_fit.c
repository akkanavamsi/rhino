
#include "unity.h"
#include "Figaro/Calibration/figaro_gpr_fit.h"
#include "Figaro/Calibration/figarofit_export.h"
#include "Figaro/Calibration/figaro_gpr_params.h"
#include "Figaro/Calibration/mpfit.h"

void setUp(void)
{
}

void tearDown(void)
{
}
#define default_num_pts 25
void test_ImaginaryHillFuncFitTest(void)
{
    // Expect two strings not to be equal.

    const size_t num_pts = default_num_pts;
    double y[default_num_pts] = {-4998.233692, -10083.34302, -8347.971176, -6578.299797, -5319.40853,
                                 -4433.270399, -3788.367268, -3302.150996, -2923.838245, -2621.801595, -2375.451141,
                                 -2170.86991, -1998.439633, -1851.372581, -1723.976919, -1612.612667, -1514.644626,
                                 -1428.258856, -1350.599781, -1281.35906, -1218.409147, -1161.511237, -1109.511402,
                                 -1062.066713, -1018.395405};
    double x[default_num_pts] = {2000, 8166.67, 14333.33, 20500, 26666.67, 32833.33, 39000, 45166.67,
                                 51333.33, 57500, 63666.67, 69833.33, 76000, 82166.67, 88333.33, 94500, 100666.67,
                                 106833.33, 113000, 119166.67, 125333.33, 131500, 137666.67, 143833.33, 150000};
    double ey[default_num_pts];
    for (int i = 0; i < num_pts; i++)
        ey[i] = 0.2; /* Data errors */
    double curveData[6] = {0, 0, 0, 0, 0, 0};
    figaro_result_t result = figaro_imaginary_hill_func_fit(x, y, ey, num_pts, curveData, 4);
    // Expect equality.
    TEST_ASSERT_EQUAL(FIGARO_OK, result);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[0], -976.2);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[1], -8874.9);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[2], 7580.8);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[3], 1.526);
}

void test_DefaultImaginaryHillFuncFitTest(void)
{
    // Expect two strings not to be equal.
    double y[default_num_pts] = {-4998.233692, -10083.34302, -8347.971176, -6578.299797, -5319.40853,
                                 -4433.270399, -3788.367268, -3302.150996, -2923.838245, -2621.801595, -2375.451141,
                                 -2170.86991, -1998.439633, -1851.372581, -1723.976919, -1612.612667, -1514.644626,
                                 -1428.258856, -1350.599781, -1281.35906, -1218.409147, -1161.511237, -1109.511402,
                                 -1062.066713, -1018.395405};
    double curveData[4] = {0, 0, 0, 0};
    figaro_result_t result = figaro_imaginary_hill_func_fit_default(y, curveData);
    // Expect equality.
    TEST_ASSERT_EQUAL(FIGARO_OK, result);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[0], -976.2);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[1], -8874.9);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[2], 7580.8);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, curveData[3], 1.526);
}

void test_DefaultRMOXFuncFitTestBadMeasurement(void)
{
    double real[default_num_pts] = {-56.96432818, -54.4026739, -57.96984339, -54.38568828,
                                    -62.32154187, -57.83587391, -58.77914094, -63.46545317,
                                    -57.0225134, -57.88092446, -60.30425038, -57.69943535,
                                    -54.41883325, -60.44742047, -57.03998284, -54.91823013,
                                    -55.4270194, -57.3112526, -55.39876436, -56.25659099,
                                    -54.15503124, -57.82488937, -58.45977002, -57.8628144,
                                    -61.32926056};
    double imag[default_num_pts] = {0.00966377, 0.08019247, 0.17147336, 0.24206896, 0.37181514,
                                    0.44890296, 0.54774341, 0.69175321, 0.67984936, 0.79047997,
                                    0.90414872, 0.95903695, 0.98051696, 1.1728143, 1.20601508,
                                    1.22644379, 1.29141746, 1.41694608, 1.45113986, 1.55757026,
                                    1.56286563, 1.75981977, 1.85776239, 1.91092383, 2.1075694};
    double curveData[2] = {0.0, 0.0};
    figaro_result_t result = figaro_r_mox_func_fit_default(real, imag, curveData);
    TEST_ASSERT_EQUAL(FIGARO_ERR_BAD_FIT_CHI_SQ, result);
}

void test_DefaultRMOXFuncFitTest(void)
{
    // Expect two strings not to be equal.
    double imag[default_num_pts] = {-2395.08308723, -6576.77646335, -6678.61648001, -5783.1203201,
                                    -4911.35787679, -4201.97362789, -3648.34241195, -3212.41379042,
                                    -2863.73745071, -2580.50185419, -2346.6111043, -2150.59075064,
                                    -1983.67282129, -1840.51407775, -1716.13366003, -1607.09696534,
                                    -1510.6455628, -1425.32218114, -1349.5258269, -1280.89635516,
                                    -1218.64829899, -1162.19116529, -1110.60911346, -1063.59658298,
                                    -1020.344888};
    double real[default_num_pts] = {13402.66998329, 9012.55711319, 5234.13595879, 3188.87071562,
                                    2096.16638163, 1470.20408037, 1087.29266191, 837.21962766,
                                    666.08892407, 544.36631613, 454.40231849, 386.35446691,
                                    334.1528453, 292.39770715, 259.16046518, 232.23231891,
                                    210.46134815, 191.56935568, 176.09373833, 162.7086377,
                                    151.07204452, 141.40867018, 132.80086506, 125.36338724,
                                    118.47277423};
    double curveData[2] = {0, 0};
    figaro_result_t result = figaro_r_mox_func_fit_default(real, imag, curveData);
    // Expect equality.
    TEST_ASSERT_EQUAL(result, FIGARO_OK);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 13797.53, curveData[0]);
    TEST_ASSERT_DOUBLE_WITHIN(1e-11, 1.02579e-9, curveData[1]);
}

void test_predFigaroGPRImag6ParamTest(void)
{
    double curveData[4] = {-976.2, -8874.9, 7580.8, 1.526};

    double testT = predFigaroGPRImag6Param(curveData, 37.03, 20.83);

    TEST_ASSERT_DOUBLE_WITHIN(1.0, -6.7460, testT);
}

void test_predFigaroGPRR3ParamTest(void)
{

    double testT = predFigaroGPRR3Param(2.0238e+04, 37.0300, 20.8300);

    TEST_ASSERT_DOUBLE_WITHIN(0.1, -6.4, testT);
}

void test_figaro_r_t_rh_calibration_realimag(void)
{
    // Expect two strings not to be equal.
    double imag[25] = {-2395.08308723, -6576.77646335, -6678.61648001, -5783.1203201,
                       -4911.35787679, -4201.97362789, -3648.34241195, -3212.41379042,
                       -2863.73745071, -2580.50185419, -2346.6111043, -2150.59075064,
                       -1983.67282129, -1840.51407775, -1716.13366003, -1607.09696534,
                       -1510.6455628, -1425.32218114, -1349.5258269, -1280.89635516,
                       -1218.64829899, -1162.19116529, -1110.60911346, -1063.59658298,
                       -1020.344888};
    double real[25] = {13402.66998329, 9012.55711319, 5234.13595879, 3188.87071562,
                       2096.16638163, 1470.20408037, 1087.29266191, 837.21962766,
                       666.08892407, 544.36631613, 454.40231849, 386.35446691,
                       334.1528453, 292.39770715, 259.16046518, 232.23231891,
                       210.46134815, 191.56935568, 176.09373833, 162.7086377,
                       151.07204452, 141.40867018, 132.80086506, 125.36338724,
                       118.47277423};
    double ppm = figaro_r_t_rh_calibration_realimag(real, imag, 24.03, 71.71);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 16.2, ppm);
}

void test_figaro_r_t_rh_calibration(void)
{
    // Expect two strings not to be equal.
    double magnitude[25] = {13614.991211, 11157.068359, 8485.287109, 6604.04248,
                            5339.976563, 4451.750488, 3806.915771, 3319.719727,
                            2940.181396, 2637.294922, 2390.201904, 2185.019531,
                            2011.620239, 1863.595581, 1735.591797, 1623.789551,
                            1525.235718, 1438.138428, 1360.966187, 1291.189209,
                            1227.976563, 1170.762451, 1118.520752, 1070.959229,
                            1027.199829};
    double angle_deg[25] = {-10.131918, -36.11953, -51.913647, -61.127216, -66.887222,
                            -70.715866, -73.404694, -75.392509, -76.906143, -78.087898,
                            280.959229, 280.18457, 279.561798, -80.973007, -81.412415,
                            -81.777435, -82.068672, -82.345078, -82.565727, -82.760651,
                            -82.933273, -83.062683, -83.181244, 276.72229, 276.622986};
    double ppm = figaro_r_t_rh_calibration(magnitude, angle_deg, 24.03, 71.71);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 16.2, ppm);
}

void test_figaro_r_t_rh_calibration_error(void)
{
    // Expect two strings not to be equal.
    double magnitude[25] = {13614.991211, 11157.068359, 8485.287109, 6604.04248,
                            5339.976563, 4451.750488, 3806.915771, 3319.719727,
                            2940.181396, 2637.294922, 2390.201904, 2185.019531,
                            2011.620239, 1863.595581, 1735.591797, 1623.789551,
                            1525.235718, 1438.138428, 1360.966187, 1291.189209,
                            1227.976563, 1170.762451, 1118.520752, 1070.959229,
                            1027.199829};
    double angle_deg[25] = {-10.131918, -36.11953, -51.913647, -61.127216, -66.887222,
                            -70.715866, -73.404694, -75.392509, -76.906143, -78.087898,
                            280.959229, 280.18457, 279.561798, -80.973007, -81.412415,
                            -81.777435, -82.068672, -82.345078, -82.565727, -82.760651,
                            -82.933273, -83.062683, -83.181244, 276.72229, 276.622986};
    double ppm, R, C;
    figaro_result_t res = figaro_r_t_rh_calibration_error(magnitude, angle_deg, 24.03, 71.71, &ppm, &R, &C);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 16.2, ppm);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 13797.53, R);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, C);
    TEST_ASSERT_EQUAL(FIGARO_OK, res);
}

void test_figaro_r_t_rh_calibration_bad_meas1(void)
{
    // Expect two strings not to be equal.
    double real[25] = {-56.96432818, -54.4026739, -57.96984339, -54.38568828,
                       -62.32154187, -57.83587391, -58.77914094, -63.46545317,
                       -57.0225134, -57.88092446, -60.30425038, -57.69943535,
                       -54.41883325, -60.44742047, -57.03998284, -54.91823013,
                       -55.4270194, -57.3112526, -55.39876436, -56.25659099,
                       -54.15503124, -57.82488937, -58.45977002, -57.8628144,
                       -61.32926056};
    double imag[25] = {0.00966377, 0.08019247, 0.17147336, 0.24206896, 0.37181514,
                       0.44890296, 0.54774341, 0.69175321, 0.67984936, 0.79047997,
                       0.90414872, 0.95903695, 0.98051696, 1.1728143, 1.20601508,
                       1.22644379, 1.29141746, 1.41694608, 1.45113986, 1.55757026,
                       1.56286563, 1.75981977, 1.85776239, 1.91092383, 2.1075694};
    double ppm = figaro_r_t_rh_calibration_realimag(real, imag, 25.34, 29.58);
    // Expect NAN.
    TEST_ASSERT_TRUE(!(ppm <= ppm));
}

void test_figaro_r_t_rh_calibration_bad_meas2(void)
{
    // Expect two strings not to be equal.
    double real[25] = {54.94316021, 53.48513686, 55.23967628, 53.06813525, 54.94509407,
                       53.56753554, 54.27763413, 50.61420035, 51.94510018, 50.60287493,
                       49.00736988, 48.28849608, 50.17922126, 50.0807504, 49.71152618,
                       55.70833882, 54.34223441, 57.39450859, 52.97212834, 51.68726557,
                       54.41360148, 54.8676893, 56.99229044, 52.65583677, 53.00919713};
    double imag[25] = {-0.00934486, -0.07886144, -0.16341784, -0.23622217, -0.32782011,
                       -0.41576512, -0.50582188, -0.55169543, -0.61932038, -0.69110041,
                       -0.73478353, -0.80262377, -0.90413476, -0.97168486, -1.05109229,
                       -1.24410226, -1.26615968, -1.41902753, -1.38759028, -1.43107518,
                       -1.57033154, -1.66982918, -1.81114007, -1.73897404, -1.82167317};
    double ppm = figaro_r_t_rh_calibration_realimag(real, imag, 25.34, 29.58);
    // Expect NAN.
    TEST_ASSERT_TRUE(!(ppm <= ppm));
}

void test_DefaultRMOXMagFuncFitTestMagAng(void)
{
    // Expect two strings not to be equal.
    double mag[25] = {28336.67333846, 14286.23355552, 8781.29283606, 6273.95055605,
                      4866.00576721, 3968.96562, 3350.66472359, 2897.62751144,
                      2552.73910094, 2280.7731881, 2060.80846158, 1879.76353852,
                      1727.95720291, 1598.52379823, 1487.29495127, 1389.99307258,
                      1305.21290567, 1230.00381429, 1162.95961436, 1102.62734512,
                      1048.53254385, 999.1600187, 954.52512108, 913.31923793,
                      875.85157062};
    double ang[25] = {-25.605925, -62.74379, -73.454674, -78.082802, -80.602966, -82.152573,
                      -83.188187, -83.930435, -84.470711, -84.875061, 274.805725, 274.565765,
                      274.383057, -85.767982, -85.880623, -85.961624, -86.007133, -86.069565,
                      -86.072899, -86.088829, -86.086327, -86.076172, -86.064056, 273.960724,
                      274.003357};
    double curveData[2] = {0, 0};
    double real[25], imag[25];
    convert_polar_to_realimag(mag, ang, real, imag, 25);

    figaro_result_t result = figaro_r_mox_func_fit_default(real, imag, curveData);
    // Expect equality.
    TEST_ASSERT_EQUAL(FIGARO_OK, result);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 31184.02, curveData[0]);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, curveData[1]);
}

void test_figaro_r_ah_calibration_near_bad_meas2(void)
{
    // Expect two strings not to be equal.
    double mag[25] = {29110.81498581, 16120.01218219, 10127.59868344, 7279.36006216,
                      5660.95781498, 4623.93031975, 3906.85639378, 3380.91127859,
                      2978.80985412, 2662.11172051, 2406.54217434, 2195.4059648,
                      2018.11820412, 1867.00782523, 1736.95125194, 1624.04278702,
                      1524.96398168, 1437.14492638, 1358.82109111, 1288.64832351,
                      1225.23715141, 1167.86835768, 1115.36417535, 1067.7130918,
                      1023.80132209};
    double ang[25] = {-22.31389, -59.028316, -70.955994, -76.256798, -79.178871, -81.000076,
                      -82.228691, -83.105469, -83.751717, -84.245674, 275.364777, 275.059204,
                      274.821991, -85.38195, -85.532455, -85.647476, -85.719269, -85.795662,
                      -85.845558, -85.902924, -85.89856, -85.916405, -85.905205, 274.094757,
                      274.088318};
    double ppm, R, C;
    figaro_result_t res = figaro_r_ah_calibration_error(mag, ang, 11.73, 30.47, &ppm, &R, &C);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 0.52, ppm);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 31438.04, R);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, C);
    TEST_ASSERT_EQUAL(FIGARO_OK, res);
}

void test_figaro_r_ah_calibration_near_bad_meas3(void)
{
    // Expect two strings not to be equal.
    double mag[25] = {34641.066406, 16930.710938, 10337.483398, 7368.832031,
                      5717.636719, 4661.831055, 3934.543457, 3402.797119,
                      2996.712891, 2677.227295, 2419.087402, 2206.622314,
                      2028.598267, 1876.566772, 1745.837402, 1632.256714,
                      1532.265991, 1444.077393, 1365.247681, 1294.595337,
                      1230.978638, 1173.195068, 1120.48584, 1072.762695,
                      1028.438232};
    double ang[25] = {-27.030991, -63.93306, -74.230652, -78.631615, -81.047874,
                      -82.526245, -83.511208, -84.208199, -84.714828, -85.092712,
                      274.612061, 274.382233, 274.19751, -85.933289, -86.039803,
                      -86.118584, -86.148521, -86.2145, -86.226479, -86.227867,
                      -86.219543, -86.195038, -86.192596, 273.820313, 273.862244};
    double ppm, R, C;
    figaro_result_t res = figaro_r_ah_calibration_error(mag, ang, 26.43, 12.36, &ppm, &R, &C);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 24.46, ppm);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 38851.5, R);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, C);
    TEST_ASSERT_EQUAL(FIGARO_OK, res);
}

void test_figaro_r_ah_calibration_near_bad_meas4(void)
{
    // Expect two strings not to be equal.
    double mag[25] = {21485.93123133, 12662.03168814, 8105.01189884, 5862.04466352,
                      4577.78973666, 3744.0490762, 3165.91276234, 2740.69428494,
                      2415.699936, 2159.41750165, 1951.78807099, 1780.8564348,
                      1637.22338173, 1515.25903206, 1409.83501879, 1318.25497278,
                      1237.38651451, 1166.31471056, 1102.79202676, 1045.86209834,
                      994.47968145, 947.73802791, 905.39309107, 866.66784082,
                      830.75901047};
    double ang[25] = {-20.488295, -56.211468, -68.942375, -74.732674, -77.988205,
                      -80.029152, -81.396507, -82.363823, -83.088631, -83.642487,
                      275.924896, 275.576355, 275.308716, -84.908348, -85.07579,
                      -85.222664, -85.320526, -85.421524, -85.477615, -85.532097,
                      -85.547455, -85.567596, -85.589836, 274.428528, 274.410461};
    double ppm, R, C;
    figaro_result_t res = figaro_r_ah_calibration_error(mag, ang, 26.43, 13.06, &ppm, &R, &C);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 8.58, ppm);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 22634.9, R);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, C);
    TEST_ASSERT_EQUAL(FIGARO_OK, res);
}

void test_figaro_r_ah_calibration_burc_data(void)
{
    // Expect two strings not to be equal.
    double ZR[25] = {21870.15619, 9847.954625, 4464.723622, 2435.992729,
                     1519.076686, 1036.604807, 754.688346, 575.697609,
                     456.6373, 372.046215, 310.092841, 264.287965,
                     228.352039, 201.145716, 178.372445, 160.002946,
                     145.813191, 133.456163, 122.671796, 114.070846,
                     106.520685, 99.9362, 94.41826, 89.279087,
                     84.942962};
    double ZI[25] = {-6353.370058, -11657.26373, -9218.350719, -7129.660191,
                     -5726.479645, -4754.124583, -4053.010368, -3528.123819,
                     -3121.087417, -2797.155566, -2533.146618, -2314.614412,
                     -2130.095769, -1972.670043, -1836.689337, -1717.903864,
                     -1613.616777, -1521.515862, -1438.89299, -1364.94842,
                     -1298.116394, -1237.465581, -1182.126564, -1131.851534,
                     -1085.329495};
    double ppm, R, C;
    figaro_result_t res = figaro_r_ah_calibration_realimag_error(ZR, ZI, 26.43, 13.06, &ppm, &R, &C);
    // Expect equality.
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 10.06, ppm);
    TEST_ASSERT_DOUBLE_WITHIN(0.1, 23674.6, R);
    TEST_ASSERT_DOUBLE_WITHIN(2e-12, 1.0258e-9, C);
    TEST_ASSERT_EQUAL(FIGARO_OK, res);
}
